<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>è®¸æ°è½®èƒåº— - Firestoreäº‘ç«¯åŒæ­¥ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: #1a1f3a;
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .page {
            display: none;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .page.active {
            display: block;
        }

        .header {
            background: #1a1f3a;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: #4a7aff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
        }

        .header-title h2 {
            font-size: 16px;
            font-weight: bold;
        }

        .header-title p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 2px;
        }

        .header-logout {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: rgba(255, 255, 255, 0.7);
        }

        .back-btn {
            font-size: 28px;
            cursor: pointer;
            margin-right: 16px;
            color: #4a7aff;
        }

        .welcome-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .app-logo {
            width: 100px;
            height: 100px;
            background: #4a7aff;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 48px;
        }

        .app-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 60px;
        }

        .role-card {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            margin: 12px 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        .role-card.boss {
            background: rgba(42, 48, 74, 0.8);
        }

        .role-icon {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 20px;
        }

        .role-info h3 {
            font-size: 20px;
            margin-bottom: 6px;
        }

        .role-info p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .role-arrow {
            margin-left: auto;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.4);
        }

        .login-page {
            padding: 40px 20px;
        }

        .login-header {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a7aff;
            background: rgba(255, 255, 255, 0.1);
        }

        .form-group input[readonly] {
            background: rgba(255, 255, 255, 0.03);
            color: rgba(255, 255, 255, 0.5);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4a7aff;
            color: white;
        }

        .btn-primary:hover {
            background: #3a6aef;
        }

        .btn-success {
            background: #34d399;
            color: white;
        }

        .btn-success:hover {
            background: #24c389;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-top: 12px;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .small-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .small-link a {
            color: #4a7aff;
            text-decoration: none;
            cursor: pointer;
        }

        .content {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a7aff;
        }

        .profit-card {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 20px 20px;
        }

        .profit-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .profit-value {
            font-size: 36px;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
            margin: 0 20px 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.6);
        }

        .tab.active {
            background: #4a7aff;
            color: white;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #242a45;
            display: flex;
            justify-content: space-around;
            padding: 12px 0 16px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .nav-item.active {
            background: rgba(74, 122, 255, 0.2);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-item.active .nav-icon {
            color: #4a7aff;
        }

        .nav-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .nav-item.active .nav-label {
            color: #4a7aff;
        }

        .section-title {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            padding: 0 20px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-list {
            padding: 0 20px 20px;
        }

        .record-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .record-title {
            font-size: 16px;
            font-weight: bold;
        }

        .record-price {
            font-size: 18px;
            color: #34d399;
            font-weight: bold;
        }

        .record-detail {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
        }

        .inventory-list {
            padding: 0 20px 20px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-info {
            flex: 1;
        }

        .inventory-brand {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .inventory-model {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 4px;
        }

        .inventory-price {
            font-size: 12px;
            color: #4a7aff;
        }

        .inventory-count {
            background: #4a7aff;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .search-box {
            padding: 0 20px 16px;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
        }

        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #4a7aff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(74, 122, 255, 0.4);
            z-index: 99;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .form-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 0 20px 20px;
        }

        .form-card h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        select option {
            background: #242a45;
            color: #fff;
            padding: 10px;
        }

        .other-inputs {
            display: none;
        }

        .other-inputs.show {
            display: block;
        }

        .approved-badge {
            display: inline-block;
            background: #34d399;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(52, 211, 153, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .sync-indicator.syncing {
            background: rgba(74, 122, 255, 0.9);
            display: flex;
        }

        .sync-indicator.error {
            background: rgba(239, 68, 68, 0.9);
            display: flex;
        }

        .sync-indicator .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .app-title {
                font-size: 24px;
            }

            .role-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 20px;
            }

            .profit-value {
                font-size: 28px;
            }
        }
    </style>

    <!-- Firebase SDK æ¨¡å—åŒ–å¯¼å…¥ - ä½¿ç”¨ Firestore -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBESEcLq8v9ChKerWh2egh_SyLRxlbHVqU",
            authDomain: "finance-7c50c.firebaseapp.com",
            projectId: "finance-7c50c",
            storageBucket: "finance-7c50c.firebasestorage.app",
            messagingSenderId: "790824328676",
            appId: "1:790824328676:web:e0fc581d972b9ce0c2bbf1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firestoreDB = db;
        window.firestoreDoc = doc;
        window.firestoreSetDoc = setDoc;
        window.firestoreGetDoc = getDoc;
        window.firestoreOnSnapshot = onSnapshot;
        window.firestoreCollection = collection;
        window.firestoreServerTimestamp = serverTimestamp;

        console.log('âœ… Firebase Firestore initialized successfully');
        console.log('âœ… Firestore database:', db);
        console.log('ğŸ“ è¯·ç¡®ä¿å·²åœ¨Firebase Consoleåˆ›å»ºFirestoreæ•°æ®åº“');
        console.log('ğŸ“ é¡¹ç›®: finance-7c50c');

        // æµ‹è¯•Firestoreè¿æ¥
        setTimeout(async () => {
            try {
                const testRef = doc(db, 'test', 'connection');
                await setDoc(testRef, { test: true, timestamp: new Date().toISOString() });
                console.log('âœ… Firestoreè¿æ¥æµ‹è¯•æˆåŠŸï¼å¯ä»¥å¼€å§‹ä½¿ç”¨äº‘ç«¯åŒæ­¥åŠŸèƒ½');
                console.log('âœ… æ•°æ®å°†ä¿å­˜åˆ°: https://console.firebase.google.com/project/finance-7c50c/firestore');
            } catch (error) {
                console.error('âŒ Firestoreè¿æ¥å¤±è´¥:', error);
                console.error('âŒ é”™è¯¯ä¿¡æ¯:', error.message);
                console.error('');
                console.error('ğŸ”§ è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š');
                console.error('1. è®¿é—® https://console.firebase.google.com/project/finance-7c50c/firestore');
                console.error('2. å¦‚æœæ˜¾ç¤º"å¼€å§‹ä½¿ç”¨"æŒ‰é’®ï¼Œç‚¹å‡»å®ƒ');
                console.error('3. é€‰æ‹©"ä»¥æµ‹è¯•æ¨¡å¼å¯åŠ¨"');
                console.error('4. ä½ç½®é€‰æ‹© asia-east1 (é¦™æ¸¯)');
                console.error('5. ç‚¹å‡»"å¯ç”¨"');
                console.error('6. ç­‰å¾…æ•°æ®åº“åˆ›å»ºå®Œæˆåï¼Œåˆ·æ–°æ­¤é¡µé¢');
                console.error('');
                alert('âš ï¸ Firestoreæ•°æ®åº“æœªåˆ›å»ºæˆ–æƒé™é”™è¯¯\n\n' +
                      'è¯·è®¿é—®Firebase Consoleåˆ›å»ºFirestoreæ•°æ®åº“ï¼š\n\n' +
                      '1. æ‰“å¼€ Firebase Console\n' +
                      '2. é¡¹ç›®: finance-7c50c\n' +
                      '3. Firestore Database â†’ åˆ›å»ºæ•°æ®åº“\n' +
                      '4. é€‰æ‹©"æµ‹è¯•æ¨¡å¼"\n' +
                      '5. åˆ·æ–°é¡µé¢\n\n' +
                      'è¯¦ç»†é”™è¯¯: ' + error.message);
            }
        }, 1000);
    </script>
</head>
<body>
    <!-- åŒæ­¥æŒ‡ç¤ºå™¨ -->
    <div id="syncIndicator" class="sync-indicator">
        <div class="spinner"></div>
        <span id="syncText">åŒæ­¥ä¸­...</span>
    </div>

    <!-- é¡µé¢1: æ¬¢è¿é¡µ -->
    <div id="welcomePage" class="page active welcome-page">
        <div class="app-logo">ğŸ‘¥</div>
        <h1 class="app-title">è®¸æ°è½®èƒåº—</h1>

        <div class="role-card" onclick="goToPage('employeeLoginPage')">
            <div class="role-icon">ğŸ”§</div>
            <div class="role-info">
                <h3>æˆ‘æ˜¯å‘˜å·¥</h3>
                <p>è®°è´¦/æŸ¥è¯¢</p>
            </div>
            <div class="role-arrow">â†’</div>
        </div>

        <div class="role-card boss" onclick="checkBossAutoLogin()">
            <div class="role-icon">ğŸ›¡ï¸</div>
            <div class="role-info">
                <h3>æˆ‘æ˜¯è€æ¿</h3>
                <p>ç®¡ç†/åˆ©æ¶¦</p>
            </div>
            <div class="role-arrow">â†’</div>
        </div>

        <div style="margin-top: 40px; text-align: center; font-size: 12px; color: rgba(255,255,255,0.4);">
            Firestoreäº‘ç«¯åŒæ­¥ç‰ˆ v3.1<br>
            <span style="font-size: 10px;">å®æ—¶å¤šè®¾å¤‡äº‘ç«¯åŒæ­¥ (Firestore)</span>
        </div>
    </div>

    <!-- é¡µé¢2: å‘˜å·¥ç™»å½• -->
    <div id="employeeLoginPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="goToPage('welcomePage')">â†</div>
            <h2 class="login-title">å‘˜å·¥ç™»å½•</h2>
        </div>

        <div class="form-group">
            <label>å‘˜å·¥å§“å</label>
            <input type="text" id="empLoginName" placeholder="è¯·è¾“å…¥å§“å">
        </div>
        <div class="form-group">
            <label>ç™»å½•å¯†ç </label>
            <input type="password" id="empLoginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>
        <button class="btn btn-primary" onclick="loginEmployee()">ç™»å½•</button>

        <div class="small-link">
            <a onclick="goToPage('employeeRegisterPage')">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</a>
        </div>
    </div>

    <!-- é¡µé¢3: å‘˜å·¥æ³¨å†Œ -->
    <div id="employeeRegisterPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="goToPage('employeeLoginPage')">â†</div>
            <h2 class="login-title">å‘˜å·¥æ³¨å†Œ</h2>
        </div>

        <div class="form-group">
            <label>å‘˜å·¥å§“å</label>
            <input type="text" id="empRegName" placeholder="è¯·è¾“å…¥å§“å">
        </div>
        <div class="form-group">
            <label>è®¾ç½®å¯†ç </label>
            <input type="password" id="empRegPassword" placeholder="è¯·è®¾ç½®ç™»å½•å¯†ç ">
        </div>
        <div class="form-group">
            <label>ç¡®è®¤å¯†ç </label>
            <input type="password" id="empRegPasswordConfirm" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
        </div>
        <button class="btn btn-success" onclick="registerEmployee()">æäº¤æ³¨å†Œ</button>
    </div>

    <!-- é¡µé¢4: è€æ¿ç™»å½• -->
    <div id="bossLoginPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="goToPage('welcomePage')">â†</div>
            <h2 class="login-title">è€æ¿ç™»å½•</h2>
        </div>

        <div class="form-group">
            <label>è€æ¿å¯†ç </label>
            <input type="password" id="bossLoginPassword" placeholder="è¯·è¾“å…¥è€æ¿å¯†ç ">
        </div>
        <button class="btn btn-success" onclick="loginBoss()">ç™»å½•</button>
    </div>

    <!-- è€æ¿PINéªŒè¯é¡µé¢ -->
    <div id="bossPinPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="goToPage('welcomePage')">â†</div>
            <h2 class="login-title">å¿«é€Ÿç™»å½•</h2>
        </div>

        <div class="form-group">
            <label>è¾“å…¥PINç </label>
            <input type="password" id="bossPinInput" placeholder="è¯·è¾“å…¥PINç " maxlength="4">
        </div>
        <button class="btn btn-success" onclick="verifyBossPin()">ç¡®è®¤</button>
    </div>

    <!-- é¡µé¢5: å‘˜å·¥ä¸»é¡µ -->
    <div id="employeeMainPage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ”§</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p id="empNameDisplay">å‘˜å·¥ç«¯</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="section-title">
            <span>ä»Šæ—¥è®°å½•</span>
            <span id="empTodayDate"></span>
        </div>

        <div class="record-list" id="empTodayRecords"></div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchEmpTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('change')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">æ¢èƒ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('repair')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è¡¥èƒ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('other')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">å…¶ä»–</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢6: å‘˜å·¥æ¢èƒ -->
    <div id="employeeChangePage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ”§</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p id="empNameDisplay2">å‘˜å·¥ç«¯</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="form-card">
            <h3>æ¢èƒè®°å½•</h3>
            <div class="form-group">
                <label>æ—¥æœŸæ—¶é—´</label>
                <input type="datetime-local" id="empChangeDate">
            </div>
            <div class="form-group">
                <label>é€‰æ‹©è½®èƒ</label>
                <select id="empChangeTire" onchange="handleEmpTireSelect()">
                    <option value="">-- è¯·é€‰æ‹© --</option>
                </select>
            </div>
            <div id="empChangeOtherInputs" class="other-inputs">
                <div class="form-group">
                    <label>è½®èƒå“ç‰Œ</label>
                    <input type="text" id="empChangeOtherBrand" placeholder="è¯·è¾“å…¥å“ç‰Œ">
                </div>
                <div class="form-group">
                    <label>è½®èƒå‹å·</label>
                    <input type="text" id="empChangeOtherModel" placeholder="è¯·è¾“å…¥å‹å·">
                </div>
            </div>
            <div class="form-group">
                <label>æ•°é‡</label>
                <input type="number" id="empChangeQty" placeholder="æ¢å‡ æ¡èƒ" min="1" oninput="calcEmpChangeTotal()">
            </div>
            <div class="form-group">
                <label>å•ä»·</label>
                <input type="number" id="empChangePrice" placeholder="æ¯æ¡å”®ä»·" step="0.01" oninput="calcEmpChangeTotal()">
            </div>
            <div class="form-group">
                <label>æ€»è®¡</label>
                <input type="text" id="empChangeTotal" placeholder="è‡ªåŠ¨è®¡ç®—" readonly>
            </div>
            <button class="btn btn-primary" onclick="submitEmpChange()">ç¡®è®¤é”€å”®</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="switchEmpTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item active" onclick="switchEmpTab('change')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">æ¢èƒ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('repair')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è¡¥èƒ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('other')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">å…¶ä»–</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢7: å‘˜å·¥è¡¥èƒ -->
    <div id="employeeRepairPage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ”§</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p id="empNameDisplay3">å‘˜å·¥ç«¯</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="form-card">
            <h3>è¡¥èƒè®°å½•</h3>
            <div class="form-group">
                <label>æ—¥æœŸæ—¶é—´</label>
                <input type="datetime-local" id="empRepairDate">
            </div>
            <div class="form-group">
                <label>æ•°é‡</label>
                <input type="number" id="empRepairQty" placeholder="è¡¥å‡ æ¡èƒ" min="1">
            </div>
            <div class="form-group">
                <label>ä»·æ ¼</label>
                <input type="number" id="empRepairPrice" placeholder="æ€»ä»·æ ¼" step="0.01">
            </div>
            <button class="btn btn-primary" onclick="submitEmpRepair()">ç¡®è®¤é”€å”®</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="switchEmpTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('change')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">æ¢èƒ</div>
            </div>
            <div class="nav-item active" onclick="switchEmpTab('repair')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è¡¥èƒ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('other')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">å…¶ä»–</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢8: å‘˜å·¥å…¶ä»–ä¸šåŠ¡ -->
    <div id="employeeOtherPage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ”§</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p id="empNameDisplay4">å‘˜å·¥ç«¯</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="form-card">
            <h3>å…¶ä»–ä¸šåŠ¡</h3>
            <div class="form-group">
                <label>æ—¥æœŸæ—¶é—´</label>
                <input type="datetime-local" id="empOtherDate">
            </div>
            <div class="form-group">
                <label>ä¸šåŠ¡äº‹é¡¹</label>
                <textarea id="empOtherDesc" placeholder="è¯·æè¿°ä¸šåŠ¡å†…å®¹" rows="3" style="resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>æ”¶æ¬¾é‡‘é¢</label>
                <input type="number" id="empOtherAmount" placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01">
            </div>
            <button class="btn btn-primary" onclick="submitEmpOther()">ç¡®è®¤æäº¤</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="switchEmpTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('change')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">æ¢èƒ</div>
            </div>
            <div class="nav-item" onclick="switchEmpTab('repair')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è¡¥èƒ</div>
            </div>
            <div class="nav-item active" onclick="switchEmpTab('other')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">å…¶ä»–</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢9: è€æ¿ä¸»é¡µ -->
    <div id="bossMainPage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ‘”</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p>è€æ¿ç«¯ Â· Boss</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="profit-card">
            <div class="profit-label">ä»Šæ—¥æ¯›åˆ©</div>
            <div class="profit-value" id="bossTodayProfit">Â¥0</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥è¥ä¸šé¢</div>
                <div class="stat-value" id="bossTodayRevenue">Â¥0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥å•é‡</div>
                <div class="stat-value" id="bossTodayOrders">0 å•</div>
            </div>
        </div>

        <div class="section-title">
            <span>ä»Šæ—¥è®°å½•</span>
            <span id="bossTodayDate"></span>
        </div>

        <div class="record-list" id="bossTodayRecords"></div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchBossTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('record')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è®°è´¦</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('inventory')">
                <div class="nav-icon">ğŸ“¦</div>
                <div class="nav-label">ä»“åº“</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('more')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">æ›´å¤š</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢10: è€æ¿è®°è´¦ -->
    <div id="bossRecordPage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ‘”</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p>è€æ¿ç«¯ Â· Boss</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchBossRecordTab('change')">æ¢èƒ</div>
            <div class="tab" onclick="switchBossRecordTab('repair')">è¡¥èƒ</div>
            <div class="tab" onclick="switchBossRecordTab('other')">å…¶ä»–ä¸šåŠ¡</div>
        </div>

        <div id="bossRecordChange" class="content">
            <div class="form-card" style="margin: 0;">
                <h3>æ¢èƒè®°å½•</h3>
                <div class="form-group">
                    <label>æ—¥æœŸæ—¶é—´</label>
                    <input type="datetime-local" id="bossChangeDate">
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©è½®èƒ</label>
                    <select id="bossChangeTire" onchange="handleBossTireSelect()">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                </div>
                <div id="bossChangeOtherInputs" class="other-inputs">
                    <div class="form-group">
                        <label>è½®èƒå“ç‰Œ</label>
                        <input type="text" id="bossChangeOtherBrand" placeholder="è¯·è¾“å…¥å“ç‰Œ">
                    </div>
                    <div class="form-group">
                        <label>è½®èƒå‹å·</label>
                        <input type="text" id="bossChangeOtherModel" placeholder="è¯·è¾“å…¥å‹å·">
                    </div>
                </div>
                <div class="form-group">
                    <label>æ•°é‡</label>
                    <input type="number" id="bossChangeQty" placeholder="æ¢å‡ æ¡èƒ" min="1" oninput="calcBossChangeTotal()">
                </div>
                <div class="form-group">
                    <label>å•ä»·</label>
                    <input type="number" id="bossChangePrice" placeholder="æ¯æ¡å”®ä»·" step="0.01" oninput="calcBossChangeTotal()">
                </div>
                <div class="form-group">
                    <label>æ€»è®¡</label>
                    <input type="text" id="bossChangeTotal" placeholder="è‡ªåŠ¨è®¡ç®—" readonly>
                </div>
                <button class="btn btn-primary" onclick="submitBossChange()">ç¡®è®¤é”€å”®</button>
            </div>
        </div>

        <div id="bossRecordRepair" class="content" style="display:none;">
            <div class="form-card" style="margin: 0;">
                <h3>è¡¥èƒè®°å½•</h3>
                <div class="form-group">
                    <label>æ—¥æœŸæ—¶é—´</label>
                    <input type="datetime-local" id="bossRepairDate">
                </div>
                <div class="form-group">
                    <label>æ•°é‡</label>
                    <input type="number" id="bossRepairQty" placeholder="è¡¥å‡ æ¡èƒ" min="1">
                </div>
                <div class="form-group">
                    <label>ä»·æ ¼</label>
                    <input type="number" id="bossRepairPrice" placeholder="æ€»ä»·æ ¼" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="submitBossRepair()">ç¡®è®¤é”€å”®</button>
            </div>
        </div>

        <div id="bossRecordOther" class="content" style="display:none;">
            <div class="form-card" style="margin: 0;">
                <h3>å…¶ä»–ä¸šåŠ¡</h3>
                <div class="form-group">
                    <label>æ—¥æœŸæ—¶é—´</label>
                    <input type="datetime-local" id="bossOtherDate">
                </div>
                <div class="form-group">
                    <label>ä¸šåŠ¡äº‹é¡¹</label>
                    <textarea id="bossOtherDesc" placeholder="è¯·æè¿°ä¸šåŠ¡å†…å®¹" rows="3" style="resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label>æ”¶æ¬¾é‡‘é¢</label>
                    <input type="number" id="bossOtherAmount" placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01">
                </div>
                <button class="btn btn-primary" onclick="submitBossOther()">ç¡®è®¤æäº¤</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="switchBossTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item active" onclick="switchBossTab('record')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è®°è´¦</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('inventory')">
                <div class="nav-icon">ğŸ“¦</div>
                <div class="nav-label">ä»“åº“</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('more')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">æ›´å¤š</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢11: è€æ¿ä»“åº“ -->
    <div id="bossInventoryPage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ‘”</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p>è€æ¿ç«¯ Â· Boss</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="search-box">
            <div class="search-input-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="inventorySearch" placeholder="æœç´¢å“ç‰Œ/è§„æ ¼" oninput="searchInventory()">
            </div>
        </div>

        <div class="inventory-list" id="inventoryList"></div>

        <div class="fab" onclick="goToPage('bossAddStockPage')">+</div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="switchBossTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('record')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è®°è´¦</div>
            </div>
            <div class="nav-item active" onclick="switchBossTab('inventory')">
                <div class="nav-icon">ğŸ“¦</div>
                <div class="nav-label">ä»“åº“</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('more')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">æ›´å¤š</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢12: æ·»åŠ è¿›è´§ -->
    <div id="bossAddStockPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="switchBossTab('inventory')">â†</div>
            <h2 class="login-title">å½•å…¥è¿›è´§</h2>
        </div>

        <div class="form-group">
            <label>æ—¥æœŸæ—¶é—´</label>
            <input type="datetime-local" id="stockDate">
        </div>
        <div class="form-group">
            <label>è½®èƒå“ç‰Œ</label>
            <input type="text" id="stockBrand" placeholder="ä¾‹å¦‚:ç±³å…¶æ—">
        </div>
        <div class="form-group">
            <label>è½®èƒå‹å·</label>
            <input type="text" id="stockModel" placeholder="ä¾‹å¦‚:195/65R15">
        </div>
        <div class="form-group">
            <label>æ•°é‡</label>
            <input type="number" id="stockQty" placeholder="è¿›è´§æ•°é‡" min="1">
        </div>
        <div class="form-group">
            <label>è¿›ä»·ï¼ˆå•ä»·ï¼‰</label>
            <input type="number" id="stockPrice" placeholder="æ¯æ¡è¿›è´§ä»·" step="0.01">
        </div>
        <button class="btn btn-success" onclick="submitStock()">ç¡®è®¤è¿›è´§</button>
    </div>

    <!-- é¡µé¢13: è€æ¿æ›´å¤š -->
    <div id="bossMorePage" class="page">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸ‘”</div>
                <div class="header-title">
                    <h2>è®¸æ°è½®èƒåº—</h2>
                    <p>è€æ¿ç«¯ Â· Boss</p>
                </div>
            </div>
            <div class="header-logout" onclick="logout()">âŠ—</div>
        </div>

        <div class="content">
            <div class="role-card" onclick="goToPage('bossApprovalPage')" style="max-width: 100%;">
                <div class="role-icon">ğŸ‘¥</div>
                <div class="role-info">
                    <h3>å®¡æ ¸å‘˜å·¥</h3>
                    <p>æ‰¹å‡†å‘˜å·¥æ³¨å†Œç”³è¯·</p>
                </div>
                <div class="role-arrow">â†’</div>
            </div>

            <div class="role-card" onclick="goToPage('bossHistoryPage')" style="max-width: 100%;">
                <div class="role-icon">ğŸ“ˆ</div>
                <div class="role-info">
                    <h3>å†å²æŠ¥è¡¨</h3>
                    <p>æŸ¥çœ‹å†å²æ—¥æœŸåˆ©æ¶¦ç»Ÿè®¡</p>
                </div>
                <div class="role-arrow">â†’</div>
            </div>

            <div class="role-card" onclick="goToPage('bossEmployeeManagePage')" style="max-width: 100%;">
                <div class="role-icon">ğŸ‘¨â€ğŸ’¼</div>
                <div class="role-info">
                    <h3>å‘˜å·¥ç®¡ç†</h3>
                    <p>æŸ¥çœ‹æ‰€æœ‰å‘˜å·¥åˆ—è¡¨</p>
                </div>
                <div class="role-arrow">â†’</div>
            </div>

            <div class="role-card" onclick="goToPage('bossChangePasswordPage')" style="max-width: 100%;">
                <div class="role-icon">ğŸ”</div>
                <div class="role-info">
                    <h3>ä¿®æ”¹å¯†ç </h3>
                    <p>ä¿®æ”¹è€æ¿ç™»å½•å¯†ç </p>
                </div>
                <div class="role-arrow">â†’</div>
            </div>

            <div class="role-card" onclick="goToPage('bossSettingsPage')" style="max-width: 100%;">
                <div class="role-icon">âš™ï¸</div>
                <div class="role-info">
                    <h3>ç³»ç»Ÿè®¾ç½®</h3>
                    <p>å…¶ä»–è®¾ç½®é€‰é¡¹</p>
                </div>
                <div class="role-arrow">â†’</div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="switchBossTab('main')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">æ¦‚è§ˆ</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('record')">
                <div class="nav-icon">ğŸ”§</div>
                <div class="nav-label">è®°è´¦</div>
            </div>
            <div class="nav-item" onclick="switchBossTab('inventory')">
                <div class="nav-icon">ğŸ“¦</div>
                <div class="nav-label">ä»“åº“</div>
            </div>
            <div class="nav-item active" onclick="switchBossTab('more')">
                <div class="nav-icon">âœ¨</div>
                <div class="nav-label">æ›´å¤š</div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢14: å®¡æ ¸å‘˜å·¥ -->
    <div id="bossApprovalPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="switchBossTab('more')">â†</div>
            <h2 class="login-title">å®¡æ ¸å‘˜å·¥</h2>
        </div>

        <div class="content" id="approvalList"></div>
    </div>

    <!-- é¡µé¢15: å†å²æŠ¥è¡¨ -->
    <div id="bossHistoryPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="switchBossTab('more')">â†</div>
            <h2 class="login-title">å†å²æŠ¥è¡¨</h2>
        </div>

        <div class="form-group">
            <label>é€‰æ‹©æ—¥æœŸ</label>
            <input type="date" id="historyDate">
        </div>
        <button class="btn btn-primary" onclick="loadHistoryReport()">æŸ¥çœ‹å½“æ—¥åˆ©æ¶¦</button>

        <div id="historyDisplay"></div>
    </div>

    <!-- é¡µé¢16: å‘˜å·¥ç®¡ç† -->
    <div id="bossEmployeeManagePage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="switchBossTab('more')">â†</div>
            <h2 class="login-title">å‘˜å·¥ç®¡ç†</h2>
        </div>

        <div class="content" id="employeeManageList"></div>
    </div>

    <!-- é¡µé¢17: ä¿®æ”¹å¯†ç  -->
    <div id="bossChangePasswordPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="switchBossTab('more')">â†</div>
            <h2 class="login-title">ä¿®æ”¹å¯†ç </h2>
        </div>

        <div class="form-group">
            <label>å½“å‰å¯†ç </label>
            <input type="password" id="currentPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
        </div>
        <div class="form-group">
            <label>æ–°å¯†ç </label>
            <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
        </div>
        <div class="form-group">
            <label>ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="confirmNewPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        </div>
        <button class="btn btn-primary" onclick="changeBossPassword()">ç¡®è®¤ä¿®æ”¹</button>
    </div>

    <!-- é¡µé¢18: ç³»ç»Ÿè®¾ç½® -->
    <div id="bossSettingsPage" class="page login-page">
        <div class="login-header">
            <div class="back-btn" onclick="switchBossTab('more')">â†</div>
            <h2 class="login-title">ç³»ç»Ÿè®¾ç½®</h2>
        </div>

        <div class="content">
            <div class="record-item">
                <div class="record-header">
                    <div class="record-title">æ¸…ç©ºæ‰€æœ‰æ•°æ®</div>
                </div>
                <div class="record-detail">åˆ é™¤æ‰€æœ‰ä¸šåŠ¡è®°å½•ã€åº“å­˜ã€å‘˜å·¥ç­‰æ•°æ®</div>
                <button class="btn btn-danger" style="margin-top: 12px;" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
            </div>

            <div class="record-item">
                <div class="record-header">
                    <div class="record-title">å…³äº</div>
                </div>
                <div class="record-detail">
                    è½¯ä»¶åç§°ï¼šè®¸æ°è½®èƒåº—è®°è´¦ç³»ç»Ÿ<br>
                    ç‰ˆæœ¬å·ï¼šv3.1 Firestoreäº‘ç«¯ç‰ˆ<br>
                    è¯´æ˜ï¼šå®æ—¶äº‘ç«¯åŒæ­¥ï¼Œå¤šè®¾å¤‡æ•°æ®ä¸€è‡´ (Firestore)
                </div>
            </div>
        </div>
    </div>

    <script>
// ==================== Firestoreäº‘ç«¯åŒæ­¥å‡½æ•° ====================
async function saveToCloud(key, data) {
    if (!window.firestoreDB) {
        console.warn('Firestore not initialized');
        return;
    }

    try {
        showSyncIndicator('syncing');
        const docRef = window.firestoreDoc(window.firestoreDB, key, 'data');
        await window.firestoreSetDoc(docRef, {
            content: data,
            updatedAt: window.firestoreServerTimestamp()
        });
        showSyncIndicator('success');
        console.log('Data saved to Firestore:', key);
    } catch (error) {
        console.error('Firestore sync error:', error);
        showSyncIndicator('error');
    }
}

async function loadFromCloud(key) {
    if (!window.firestoreDB) {
        console.warn('Firestore not initialized');
        return null;
    }

    try {
        const docRef = window.firestoreDoc(window.firestoreDB, key, 'data');
        const docSnap = await window.firestoreGetDoc(docRef);

        if (docSnap.exists()) {
            return docSnap.data().content;
        }
        return null;
    } catch (error) {
        console.error('Firestore load error:', error);
        return null;
    }
}

function setupRealtimeSync() {
    if (!window.firestoreDB) {
        console.warn('Firestore not initialized');
        return;
    }

    const keys = ['employees', 'tireChanges', 'tireRepairs', 'otherBusiness', 'stockRecords', 'inventory', 'bossPassword', 'bossPIN'];

    keys.forEach(key => {
        const docRef = window.firestoreDoc(window.firestoreDB, key, 'data');
        window.firestoreOnSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data().content;
                const currentData = localStorage.getItem(key);
                const cloudData = typeof data === 'string' ? data : JSON.stringify(data);

                if (currentData !== cloudData) {
                    localStorage.setItem(key, cloudData);
                    console.log('Real-time sync updated:', key);

                    // åˆ·æ–°å½“å‰æ¿€æ´»çš„é¡µé¢
                    const activePage = document.querySelector('.page.active');
                    if (activePage) {
                        const pageId = activePage.id;

                        // å‘˜å·¥ä¸»é¡µåˆ·æ–°
                        if (pageId === 'employeeMainPage') {
                            loadEmpMainPage();
                        }

                        // è€æ¿ä¸»é¡µåˆ·æ–°ï¼ˆæ¦‚è§ˆé¡µé¢ï¼‰
                        if (pageId === 'bossMainPage') {
                            loadBossMainPage();
                        }

                        // ä»“åº“é¡µé¢åˆ·æ–°
                        if (pageId === 'bossInventoryPage') {
                            loadInventory();
                        }

                        // å®¡æ ¸é¡µé¢åˆ·æ–°
                        if (pageId === 'bossApprovalPage') {
                            loadApprovalList();
                        }

                        // å‘˜å·¥ç®¡ç†é¡µé¢åˆ·æ–°
                        if (pageId === 'bossEmployeeManagePage') {
                            loadEmployeeManageList();
                        }
                    }

                    // ç‰¹åˆ«å¤„ç†ï¼šå¦‚æœä¸šåŠ¡æ•°æ®æ›´æ–°ï¼Œä¸”ç”¨æˆ·æ˜¯è€æ¿ï¼Œå¼ºåˆ¶æ›´æ–°æ¦‚è§ˆæ•°æ®
                    // è¿™æ ·å³ä½¿ä¸åœ¨æ¦‚è§ˆé¡µé¢ï¼Œæ•°æ®ä¹Ÿä¼šåœ¨åå°æ›´æ–°ï¼Œåˆ‡æ¢å›æ¥æ—¶ç«‹å³å¯è§
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (currentUser && currentUser.role === 'boss') {
                        if (key === 'tireChanges' || key === 'tireRepairs' || key === 'otherBusiness' || key === 'inventory') {
                            // é™é»˜æ›´æ–°æ¦‚è§ˆæ•°æ®ï¼ˆä¸åˆ‡æ¢é¡µé¢ï¼‰
                            updateBossStatsSilently();
                        }
                    }
                }
            }
        });
    });
}

function showSyncIndicator(status) {
    const indicator = document.getElementById('syncIndicator');
    const text = document.getElementById('syncText');

    indicator.className = 'sync-indicator';

    if (status === 'syncing') {
        indicator.classList.add('syncing');
        text.textContent = 'åŒæ­¥ä¸­...';
    } else if (status === 'success') {
        indicator.classList.remove('syncing');
        indicator.style.display = 'flex';
        indicator.style.background = 'rgba(52, 211, 153, 0.9)';
        text.textContent = 'å·²åŒæ­¥';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    } else if (status === 'error') {
        indicator.classList.add('error');
        text.textContent = 'åŒæ­¥å¤±è´¥';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 3000);
    }
}

// ==================== åˆå§‹åŒ–æ•°æ® ====================
function initData() {
    if (!localStorage.getItem('employees')) {
        localStorage.setItem('employees', JSON.stringify([]));
    }
    if (!localStorage.getItem('tireChanges')) {
        localStorage.setItem('tireChanges', JSON.stringify([]));
    }
    if (!localStorage.getItem('tireRepairs')) {
        localStorage.setItem('tireRepairs', JSON.stringify([]));
    }
    if (!localStorage.getItem('otherBusiness')) {
        localStorage.setItem('otherBusiness', JSON.stringify([]));
    }
    if (!localStorage.getItem('stockRecords')) {
        localStorage.setItem('stockRecords', JSON.stringify([]));
    }
    if (!localStorage.getItem('inventory')) {
        localStorage.setItem('inventory', JSON.stringify([]));
    }
    if (!localStorage.getItem('bossPassword')) {
        localStorage.setItem('bossPassword', '123456');
    }
    if (!localStorage.getItem('bossPIN')) {
        localStorage.setItem('bossPIN', '2468');
    }
}

// ==================== é¡µé¢åˆ‡æ¢ ====================
function goToPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');

    if (pageId === 'employeeMainPage') loadEmpMainPage();
    if (pageId === 'employeeChangePage') {
        loadTireSelector('empChangeTire');
        setDefaultDateTime('empChangeDate');
    }
    if (pageId === 'employeeRepairPage') setDefaultDateTime('empRepairDate');
    if (pageId === 'employeeOtherPage') setDefaultDateTime('empOtherDate');
    if (pageId === 'bossMainPage') loadBossMainPage();
    if (pageId === 'bossRecordPage') {
        loadTireSelector('bossChangeTire');
        setDefaultDateTime('bossChangeDate');
        setDefaultDateTime('bossRepairDate');
        setDefaultDateTime('bossOtherDate');
    }
    if (pageId === 'bossInventoryPage') loadInventory();
    if (pageId === 'bossAddStockPage') setDefaultDateTime('stockDate');
    if (pageId === 'bossApprovalPage') loadApprovalList();
    if (pageId === 'bossHistoryPage') document.getElementById('historyDate').value = getTodayDate();
    if (pageId === 'bossEmployeeManagePage') loadEmployeeManageList();
}

function setDefaultDateTime(id) {
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
    document.getElementById(id).value = localDateTime;
}

function getTodayDate() {
    return new Date().toISOString().slice(0, 10);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatDateShort(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

// ==================== å‘˜å·¥æ³¨å†Œç™»å½• ====================
function registerEmployee() {
    const name = document.getElementById('empRegName').value.trim();
    const password = document.getElementById('empRegPassword').value;
    const confirm = document.getElementById('empRegPasswordConfirm').value;

    if (!name || !password) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    if (password !== confirm) {
        alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´ï¼');
        return;
    }

    const employees = JSON.parse(localStorage.getItem('employees'));

    if (employees.find(e => e.name === name)) {
        alert('è¯¥å‘˜å·¥å§“åå·²å­˜åœ¨ï¼');
        return;
    }

    employees.push({
        name: name,
        password: password,
        approved: false,
        registeredAt: new Date().toISOString()
    });

    localStorage.setItem('employees', JSON.stringify(employees));
    saveToCloud('employees', employees);

    alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç­‰å¾…è€æ¿å®¡æ ¸');

    document.getElementById('empRegName').value = '';
    document.getElementById('empRegPassword').value = '';
    document.getElementById('empRegPasswordConfirm').value = '';

    goToPage('employeeLoginPage');
}

function loginEmployee() {
    const name = document.getElementById('empLoginName').value.trim();
    const password = document.getElementById('empLoginPassword').value;

    if (!name || !password) {
        alert('è¯·è¾“å…¥å§“åå’Œå¯†ç ï¼');
        return;
    }

    const employees = JSON.parse(localStorage.getItem('employees'));
    const emp = employees.find(e => e.name === name);

    if (!emp) {
        alert('å‘˜å·¥ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œï¼');
        return;
    }

    if (emp.password !== password) {
        alert('å¯†ç é”™è¯¯ï¼');
        return;
    }

    if (!emp.approved) {
        alert('è´¦å·å°šæœªé€šè¿‡å®¡æ ¸ï¼Œè¯·ç­‰å¾…è€æ¿æ‰¹å‡†ï¼');
        return;
    }

    localStorage.setItem('currentUser', JSON.stringify({ name: name, role: 'employee' }));
    localStorage.setItem('autoLogin', 'true');

    goToPage('employeeMainPage');
}

// ==================== è€æ¿ç™»å½• ====================
function checkBossAutoLogin() {
    const autoLogin = localStorage.getItem('autoLogin');
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));

    if (autoLogin === 'true' && currentUser && currentUser.role === 'boss') {
        goToPage('bossPinPage');
    } else {
        goToPage('bossLoginPage');
    }
}

function loginBoss() {
    const password = document.getElementById('bossLoginPassword').value;
    const correctPassword = localStorage.getItem('bossPassword');

    if (password !== correctPassword) {
        alert('å¯†ç é”™è¯¯ï¼');
        return;
    }

    localStorage.setItem('currentUser', JSON.stringify({ name: 'è€æ¿', role: 'boss' }));
    localStorage.setItem('autoLogin', 'true');

    goToPage('bossMainPage');
}

function verifyBossPin() {
    const pin = document.getElementById('bossPinInput').value;
    const correctPIN = localStorage.getItem('bossPIN');

    if (pin !== correctPIN) {
        alert('PINç é”™è¯¯ï¼');
        return;
    }

    goToPage('bossMainPage');
}

function logout() {
    localStorage.removeItem('currentUser');
    localStorage.removeItem('autoLogin');
    goToPage('welcomePage');
}

// ==================== å‘˜å·¥ç«¯åŠŸèƒ½ ====================
function switchEmpTab(tab) {
    if (tab === 'main') goToPage('employeeMainPage');
    if (tab === 'change') goToPage('employeeChangePage');
    if (tab === 'repair') goToPage('employeeRepairPage');
    if (tab === 'other') goToPage('employeeOtherPage');
}

function loadEmpMainPage() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const userName = currentUser.name;

    document.getElementById('empNameDisplay').textContent = `å‘˜å·¥ç«¯ Â· ${userName}`;
    document.getElementById('empNameDisplay2').textContent = `å‘˜å·¥ç«¯ Â· ${userName}`;
    document.getElementById('empNameDisplay3').textContent = `å‘˜å·¥ç«¯ Â· ${userName}`;
    document.getElementById('empNameDisplay4').textContent = `å‘˜å·¥ç«¯ Â· ${userName}`;

    const today = getTodayDate();
    document.getElementById('empTodayDate').textContent = formatDateShort(new Date());

    const changes = JSON.parse(localStorage.getItem('tireChanges'))
        .filter(r => r.date.startsWith(today) && r.employee === userName);
    const repairs = JSON.parse(localStorage.getItem('tireRepairs'))
        .filter(r => r.date.startsWith(today) && r.employee === userName);
    const others = JSON.parse(localStorage.getItem('otherBusiness'))
        .filter(r => r.date.startsWith(today) && r.employee === userName);

    const allRecords = [
        ...changes.map(r => ({...r, type: 'æ¢èƒ'})),
        ...repairs.map(r => ({...r, type: 'è¡¥èƒ'})),
        ...others.map(r => ({...r, type: 'å…¶ä»–ä¸šåŠ¡'}))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));

    const container = document.getElementById('empTodayRecords');

    if (allRecords.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“</div><div>æš‚æ— è®°å½•</div></div>';
    } else {
        container.innerHTML = allRecords.map(r => `
            <div class="record-item">
                <div class="record-header">
                    <div class="record-title">${r.type}</div>
                    <div class="record-price">Â¥${(r.price || r.amount || 0).toFixed(2)}</div>
                </div>
                <div class="record-detail">
                    ${r.type === 'æ¢èƒ' ? `${r.brand} ${r.model} Â· ${r.quantity}æ¡` :
                      r.type === 'è¡¥èƒ' ? `${r.quantity}æ¡` :
                      r.description}<br>
                    ${new Date(r.date).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}
                </div>
            </div>
        `).join('');
    }
}

function loadTireSelector(selectId) {
    const inventory = JSON.parse(localStorage.getItem('inventory'));
    const select = document.getElementById(selectId);

    let html = '<option value="">-- è¯·é€‰æ‹© --</option>';
    inventory.forEach((item, index) => {
        html += `<option value="${index}">${item.brand} ${item.model} (åº“å­˜:${item.quantity}æ¡)</option>`;
    });
    html += '<option value="other">å…¶ä»–</option>';

    select.innerHTML = html;
}

function handleEmpTireSelect() {
    const select = document.getElementById('empChangeTire');
    const otherInputs = document.getElementById('empChangeOtherInputs');

    if (select.value === 'other') {
        otherInputs.classList.add('show');
    } else {
        otherInputs.classList.remove('show');
    }
}

function calcEmpChangeTotal() {
    const qty = parseFloat(document.getElementById('empChangeQty').value) || 0;
    const price = parseFloat(document.getElementById('empChangePrice').value) || 0;
    const total = qty * price;
    document.getElementById('empChangeTotal').value = total > 0 ? `Â¥${total.toFixed(2)}` : '';
}

function submitEmpChange() {
    const tireIndex = document.getElementById('empChangeTire').value;
    const qty = parseInt(document.getElementById('empChangeQty').value);
    const price = parseFloat(document.getElementById('empChangePrice').value);
    const date = document.getElementById('empChangeDate').value;

    if (!tireIndex || !qty || !price || !date) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    let brand, model, isOther = false;

    if (tireIndex === 'other') {
        brand = document.getElementById('empChangeOtherBrand').value.trim();
        model = document.getElementById('empChangeOtherModel').value.trim();
        if (!brand || !model) {
            alert('è¯·å¡«å†™å“ç‰Œå’Œå‹å·ï¼');
            return;
        }
        isOther = true;
    } else {
        const inventory = JSON.parse(localStorage.getItem('inventory'));
        const tire = inventory[parseInt(tireIndex)];

        if (tire.quantity < qty) {
            alert('åº“å­˜ä¸è¶³ï¼');
            return;
        }

        brand = tire.brand;
        model = tire.model;
    }

    const changes = JSON.parse(localStorage.getItem('tireChanges'));
    changes.push({
        id: Date.now(),
        date: date,
        brand: brand,
        model: model,
        quantity: qty,
        price: qty * price,
        employee: currentUser.name,
        createdAt: new Date().toISOString()
    });
    localStorage.setItem('tireChanges', JSON.stringify(changes));
    saveToCloud('tireChanges', changes);

    if (!isOther) {
        updateInventory(brand, model, -qty);
    }

    alert('è®°å½•æˆåŠŸï¼');
    clearEmpChangeForm();
    loadEmpMainPage();
    goToPage('employeeMainPage');
}

function clearEmpChangeForm() {
    document.getElementById('empChangeTire').value = '';
    document.getElementById('empChangeOtherInputs').classList.remove('show');
    document.getElementById('empChangeOtherBrand').value = '';
    document.getElementById('empChangeOtherModel').value = '';
    document.getElementById('empChangeQty').value = '';
    document.getElementById('empChangePrice').value = '';
    document.getElementById('empChangeTotal').value = '';
}

function submitEmpRepair() {
    const date = document.getElementById('empRepairDate').value;
    const qty = parseInt(document.getElementById('empRepairQty').value);
    const price = parseFloat(document.getElementById('empRepairPrice').value);

    if (!date || !qty || !price) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const repairs = JSON.parse(localStorage.getItem('tireRepairs'));

    repairs.push({
        id: Date.now(),
        date: date,
        quantity: qty,
        price: price,
        employee: currentUser.name,
        createdAt: new Date().toISOString()
    });

    localStorage.setItem('tireRepairs', JSON.stringify(repairs));
    saveToCloud('tireRepairs', repairs);

    alert('è®°å½•æˆåŠŸï¼');
    document.getElementById('empRepairQty').value = '';
    document.getElementById('empRepairPrice').value = '';
    loadEmpMainPage();
    goToPage('employeeMainPage');
}

function submitEmpOther() {
    const date = document.getElementById('empOtherDate').value;
    const desc = document.getElementById('empOtherDesc').value.trim();
    const amount = parseFloat(document.getElementById('empOtherAmount').value);

    if (!date || !desc || !amount) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const others = JSON.parse(localStorage.getItem('otherBusiness'));

    others.push({
        id: Date.now(),
        date: date,
        description: desc,
        amount: amount,
        employee: currentUser.name,
        createdAt: new Date().toISOString()
    });

    localStorage.setItem('otherBusiness', JSON.stringify(others));
    saveToCloud('otherBusiness', others);

    alert('è®°å½•æˆåŠŸï¼');
    document.getElementById('empOtherDesc').value = '';
    document.getElementById('empOtherAmount').value = '';
    loadEmpMainPage();
    goToPage('employeeMainPage');
}

// ==================== è€æ¿ç«¯åŠŸèƒ½ ====================
function switchBossTab(tab) {
    if (tab === 'main') goToPage('bossMainPage');
    if (tab === 'record') goToPage('bossRecordPage');
    if (tab === 'inventory') goToPage('bossInventoryPage');
    if (tab === 'more') goToPage('bossMorePage');
}

function switchBossRecordTab(tab) {
    const tabs = document.querySelectorAll('#bossRecordPage .tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    document.getElementById('bossRecordChange').style.display = tab === 'change' ? 'block' : 'none';
    document.getElementById('bossRecordRepair').style.display = tab === 'repair' ? 'block' : 'none';
    document.getElementById('bossRecordOther').style.display = tab === 'other' ? 'block' : 'none';
}

// é™é»˜æ›´æ–°è€æ¿ç«¯ç»Ÿè®¡æ•°æ®ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
function updateBossStatsSilently() {
    const today = getTodayDate();
    const changes = JSON.parse(localStorage.getItem('tireChanges')).filter(r => r.date.startsWith(today));
    const repairs = JSON.parse(localStorage.getItem('tireRepairs')).filter(r => r.date.startsWith(today));
    const others = JSON.parse(localStorage.getItem('otherBusiness')).filter(r => r.date.startsWith(today));
    const inventory = JSON.parse(localStorage.getItem('inventory'));

    let revenue = 0;
    let cost = 0;

    changes.forEach(r => {
        revenue += r.price;
        const item = inventory.find(i =>
            i.brand === r.brand &&
            i.model.replace(/\//g, '') === r.model.replace(/\//g, '')
        );
        cost += (item ? item.unitPrice : 0) * r.quantity;
    });

    repairs.forEach(r => revenue += r.price);
    others.forEach(r => revenue += r.amount);

    const profit = revenue - cost;
    const orders = changes.length + repairs.length + others.length;

    // åªæ›´æ–°DOMå…ƒç´ ï¼Œä¸åˆ·æ–°æ•´ä¸ªé¡µé¢
    const profitEl = document.getElementById('bossTodayProfit');
    const revenueEl = document.getElementById('bossTodayRevenue');
    const ordersEl = document.getElementById('bossTodayOrders');

    if (profitEl) profitEl.textContent = `Â¥${profit.toFixed(2)}`;
    if (revenueEl) revenueEl.textContent = `Â¥${revenue.toFixed(2)}`;
    if (ordersEl) ordersEl.textContent = `${orders} å•`;

    console.log('ğŸ“Š é™é»˜æ›´æ–°ç»Ÿè®¡æ•°æ®:', { profit, revenue, orders });
}

function loadBossMainPage() {
    const today = getTodayDate();
    document.getElementById('bossTodayDate').textContent = formatDateShort(new Date());

    const changes = JSON.parse(localStorage.getItem('tireChanges')).filter(r => r.date.startsWith(today));
    const repairs = JSON.parse(localStorage.getItem('tireRepairs')).filter(r => r.date.startsWith(today));
    const others = JSON.parse(localStorage.getItem('otherBusiness')).filter(r => r.date.startsWith(today));
    const inventory = JSON.parse(localStorage.getItem('inventory'));

    let revenue = 0;
    let cost = 0;

    changes.forEach(r => {
        revenue += r.price;
        const item = inventory.find(i =>
            i.brand === r.brand &&
            i.model.replace(/\//g, '') === r.model.replace(/\//g, '')
        );
        cost += (item ? item.unitPrice : 0) * r.quantity;
    });

    repairs.forEach(r => revenue += r.price);
    others.forEach(r => revenue += r.amount);

    const profit = revenue - cost;
    const orders = changes.length + repairs.length + others.length;

    document.getElementById('bossTodayProfit').textContent = `Â¥${profit.toFixed(2)}`;
    document.getElementById('bossTodayRevenue').textContent = `Â¥${revenue.toFixed(2)}`;
    document.getElementById('bossTodayOrders').textContent = `${orders} å•`;

    const allRecords = [
        ...changes.map(r => ({...r, type: 'æ¢èƒ', price: r.price})),
        ...repairs.map(r => ({...r, type: 'è¡¥èƒ'})),
        ...others.map(r => ({...r, type: 'å…¶ä»–ä¸šåŠ¡', price: r.amount}))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));

    const container = document.getElementById('bossTodayRecords');

    if (allRecords.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“</div><div>æš‚æ— è®°å½•</div></div>';
    } else {
        container.innerHTML = allRecords.map(r => `
            <div class="record-item">
                <div class="record-header">
                    <div class="record-title">${r.type} - ${r.employee}</div>
                    <div class="record-price">Â¥${r.price.toFixed(2)}</div>
                </div>
                <div class="record-detail">
                    ${r.type === 'æ¢èƒ' ? `${r.brand} ${r.model} Â· ${r.quantity}æ¡` :
                      r.type === 'è¡¥èƒ' ? `${r.quantity}æ¡` :
                      r.description}<br>
                    ${new Date(r.date).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}
                </div>
            </div>
        `).join('');
    }
}

function handleBossTireSelect() {
    const select = document.getElementById('bossChangeTire');
    const otherInputs = document.getElementById('bossChangeOtherInputs');

    if (select.value === 'other') {
        otherInputs.classList.add('show');
    } else {
        otherInputs.classList.remove('show');
    }
}

function calcBossChangeTotal() {
    const qty = parseFloat(document.getElementById('bossChangeQty').value) || 0;
    const price = parseFloat(document.getElementById('bossChangePrice').value) || 0;
    const total = qty * price;
    document.getElementById('bossChangeTotal').value = total > 0 ? `Â¥${total.toFixed(2)}` : '';
}

function submitBossChange() {
    const tireIndex = document.getElementById('bossChangeTire').value;
    const qty = parseInt(document.getElementById('bossChangeQty').value);
    const price = parseFloat(document.getElementById('bossChangePrice').value);
    const date = document.getElementById('bossChangeDate').value;

    if (!tireIndex || !qty || !price || !date) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    let brand, model, isOther = false;

    if (tireIndex === 'other') {
        brand = document.getElementById('bossChangeOtherBrand').value.trim();
        model = document.getElementById('bossChangeOtherModel').value.trim();
        if (!brand || !model) {
            alert('è¯·å¡«å†™å“ç‰Œå’Œå‹å·ï¼');
            return;
        }
        isOther = true;
    } else {
        const inventory = JSON.parse(localStorage.getItem('inventory'));
        const tire = inventory[parseInt(tireIndex)];

        if (tire.quantity < qty) {
            alert('åº“å­˜ä¸è¶³ï¼');
            return;
        }

        brand = tire.brand;
        model = tire.model;
    }

    const changes = JSON.parse(localStorage.getItem('tireChanges'));
    changes.push({
        id: Date.now(),
        date: date,
        brand: brand,
        model: model,
        quantity: qty,
        price: qty * price,
        employee: 'è€æ¿',
        createdAt: new Date().toISOString()
    });
    localStorage.setItem('tireChanges', JSON.stringify(changes));
    saveToCloud('tireChanges', changes);

    if (!isOther) {
        updateInventory(brand, model, -qty);
    }

    alert('è®°å½•æˆåŠŸï¼');
    clearBossChangeForm();
    loadBossMainPage();
}

function clearBossChangeForm() {
    document.getElementById('bossChangeTire').value = '';
    document.getElementById('bossChangeOtherInputs').classList.remove('show');
    document.getElementById('bossChangeOtherBrand').value = '';
    document.getElementById('bossChangeOtherModel').value = '';
    document.getElementById('bossChangeQty').value = '';
    document.getElementById('bossChangePrice').value = '';
    document.getElementById('bossChangeTotal').value = '';
}

function submitBossRepair() {
    const date = document.getElementById('bossRepairDate').value;
    const qty = parseInt(document.getElementById('bossRepairQty').value);
    const price = parseFloat(document.getElementById('bossRepairPrice').value);

    if (!date || !qty || !price) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    const repairs = JSON.parse(localStorage.getItem('tireRepairs'));
    repairs.push({
        id: Date.now(),
        date: date,
        quantity: qty,
        price: price,
        employee: 'è€æ¿',
        createdAt: new Date().toISOString()
    });

    localStorage.setItem('tireRepairs', JSON.stringify(repairs));
    saveToCloud('tireRepairs', repairs);

    alert('è®°å½•æˆåŠŸï¼');
    document.getElementById('bossRepairQty').value = '';
    document.getElementById('bossRepairPrice').value = '';
    loadBossMainPage();
}

function submitBossOther() {
    const date = document.getElementById('bossOtherDate').value;
    const desc = document.getElementById('bossOtherDesc').value.trim();
    const amount = parseFloat(document.getElementById('bossOtherAmount').value);

    if (!date || !desc || !amount) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    const others = JSON.parse(localStorage.getItem('otherBusiness'));
    others.push({
        id: Date.now(),
        date: date,
        description: desc,
        amount: amount,
        employee: 'è€æ¿',
        createdAt: new Date().toISOString()
    });

    localStorage.setItem('otherBusiness', JSON.stringify(others));
    saveToCloud('otherBusiness', others);

    alert('è®°å½•æˆåŠŸï¼');
    document.getElementById('bossOtherDesc').value = '';
    document.getElementById('bossOtherAmount').value = '';
    loadBossMainPage();
}

function updateInventory(brand, model, qtyChange, unitPrice = null) {
    const inventory = JSON.parse(localStorage.getItem('inventory'));
    const normalizedModel = model.replace(/\//g, '');
    const index = inventory.findIndex(i =>
        i.brand === brand && i.model.replace(/\//g, '') === normalizedModel
    );

    if (index >= 0) {
        inventory[index].quantity += qtyChange;
        if (unitPrice !== null) {
            inventory[index].unitPrice = unitPrice;
        }
        if (inventory[index].quantity <= 0) {
            inventory.splice(index, 1);
        }
    } else if (qtyChange > 0) {
        inventory.push({
            brand: brand,
            model: model,
            quantity: qtyChange,
            unitPrice: unitPrice || 0
        });
    }

    localStorage.setItem('inventory', JSON.stringify(inventory));
    saveToCloud('inventory', inventory);
}

function submitStock() {
    const date = document.getElementById('stockDate').value;
    const brand = document.getElementById('stockBrand').value.trim();
    const model = document.getElementById('stockModel').value.trim();
    const qty = parseInt(document.getElementById('stockQty').value);
    const price = parseFloat(document.getElementById('stockPrice').value);

    if (!date || !brand || !model || !qty || !price) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    const records = JSON.parse(localStorage.getItem('stockRecords'));
    records.push({
        id: Date.now(),
        date: date,
        brand: brand,
        model: model,
        quantity: qty,
        unitPrice: price,
        totalPrice: qty * price,
        createdAt: new Date().toISOString()
    });
    localStorage.setItem('stockRecords', JSON.stringify(records));
    saveToCloud('stockRecords', records);

    updateInventory(brand, model, qty, price);

    alert('è¿›è´§æˆåŠŸï¼åº“å­˜å·²æ›´æ–°');
    document.getElementById('stockBrand').value = '';
    document.getElementById('stockModel').value = '';
    document.getElementById('stockQty').value = '';
    document.getElementById('stockPrice').value = '';

    switchBossTab('inventory');
}

function loadInventory() {
    const inventory = JSON.parse(localStorage.getItem('inventory'));
    const container = document.getElementById('inventoryList');

    if (inventory.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div>æš‚æ— åº“å­˜</div></div>';
        return;
    }

    container.innerHTML = inventory.map(item => `
        <div class="inventory-item">
            <div class="inventory-info">
                <div class="inventory-brand">${item.brand}</div>
                <div class="inventory-model">${item.model}</div>
                <div class="inventory-price">æˆæœ¬: Â¥${item.unitPrice.toFixed(2)}/æ¡</div>
            </div>
            <div class="inventory-count">${item.quantity} æ¡</div>
        </div>
    `).join('');
}

function searchInventory() {
    const searchTerm = document.getElementById('inventorySearch').value.trim().toLowerCase().replace(/\//g, '');
    const inventory = JSON.parse(localStorage.getItem('inventory'));
    const container = document.getElementById('inventoryList');

    if (!searchTerm) {
        loadInventory();
        return;
    }

    const results = inventory.filter(item =>
        item.brand.toLowerCase().includes(searchTerm) ||
        item.model.replace(/\//g, '').toLowerCase().includes(searchTerm)
    );

    if (results.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ”</div><div>æœªæ‰¾åˆ°åŒ¹é…é¡¹</div></div>';
        return;
    }

    container.innerHTML = results.map(item => `
        <div class="inventory-item">
            <div class="inventory-info">
                <div class="inventory-brand">${item.brand}</div>
                <div class="inventory-model">${item.model}</div>
                <div class="inventory-price">æˆæœ¬: Â¥${item.unitPrice.toFixed(2)}/æ¡</div>
            </div>
            <div class="inventory-count">${item.quantity} æ¡</div>
        </div>
    `).join('');
}

function loadApprovalList() {
    const employees = JSON.parse(localStorage.getItem('employees'));
    const pending = employees.filter(e => !e.approved);
    const container = document.getElementById('approvalList');

    if (pending.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ“</div><div>æš‚æ— å¾…å®¡æ ¸</div></div>';
    } else {
        container.innerHTML = pending.map(emp => `
            <div class="record-item">
                <div class="record-header">
                    <div class="record-title">${emp.name}</div>
                </div>
                <div class="record-detail">æ³¨å†Œæ—¶é—´: ${formatDate(emp.registeredAt)}</div>
                <button class="btn btn-success" style="margin-top: 12px;" onclick="approveEmployee('${emp.name}')">æ‰¹å‡†</button>
                <button class="btn btn-secondary" style="margin-top: 8px;" onclick="rejectEmployee('${emp.name}')">æ‹’ç»</button>
            </div>
        `).join('');
    }
}

function approveEmployee(name) {
    const employees = JSON.parse(localStorage.getItem('employees'));
    const emp = employees.find(e => e.name === name);
    if (emp) {
        emp.approved = true;
        localStorage.setItem('employees', JSON.stringify(employees));
        saveToCloud('employees', employees);
        alert(`å·²æ‰¹å‡† ${name}`);
        loadApprovalList();
    }
}

function rejectEmployee(name) {
    if (!confirm(`ç¡®å®šæ‹’ç» ${name} çš„æ³¨å†Œç”³è¯·å—ï¼Ÿ`)) return;
    const employees = JSON.parse(localStorage.getItem('employees'));
    const updatedEmployees = employees.filter(e => e.name !== name);
    localStorage.setItem('employees', JSON.stringify(updatedEmployees));
    saveToCloud('employees', updatedEmployees);
    alert(`å·²æ‹’ç» ${name}`);
    loadApprovalList();
}

function loadHistoryReport() {
    const selectedDate = document.getElementById('historyDate').value;
    if (!selectedDate) {
        alert('è¯·é€‰æ‹©æ—¥æœŸï¼');
        return;
    }

    const changes = JSON.parse(localStorage.getItem('tireChanges')).filter(r => r.date.startsWith(selectedDate));
    const repairs = JSON.parse(localStorage.getItem('tireRepairs')).filter(r => r.date.startsWith(selectedDate));
    const others = JSON.parse(localStorage.getItem('otherBusiness')).filter(r => r.date.startsWith(selectedDate));
    const inventory = JSON.parse(localStorage.getItem('inventory'));

    let revenue = 0;
    let cost = 0;

    changes.forEach(r => {
        revenue += r.price;
        const item = inventory.find(i =>
            i.brand === r.brand &&
            i.model.replace(/\//g, '') === r.model.replace(/\//g, '')
        );
        cost += (item ? item.unitPrice : 0) * r.quantity;
    });

    const repairRevenue = repairs.reduce((sum, r) => sum + r.price, 0);
    const otherRevenue = others.reduce((sum, r) => sum + r.amount, 0);
    revenue += repairRevenue + otherRevenue;

    const profit = revenue - cost;

    const container = document.getElementById('historyDisplay');
    container.innerHTML = `
        <div class="profit-card" style="margin: 20px 0;">
            <div class="profit-label">${selectedDate} æ¯›åˆ©</div>
            <div class="profit-value">Â¥${profit.toFixed(2)}</div>
        </div>
        <div class="record-item">
            <div class="record-header">
                <div class="record-title">æ¢èƒä¸šåŠ¡</div>
            </div>
            <div class="record-detail">
                é”€å”®é¢: Â¥${changes.reduce((sum, r) => sum + r.price, 0).toFixed(2)}<br>
                æˆæœ¬: Â¥${cost.toFixed(2)}<br>
                åˆ©æ¶¦: Â¥${(changes.reduce((sum, r) => sum + r.price, 0) - cost).toFixed(2)}<br>
                æ¢èƒæ•°é‡: ${changes.reduce((sum, r) => sum + r.quantity, 0)} æ¡
            </div>
        </div>
        <div class="record-item">
            <div class="record-header">
                <div class="record-title">è¡¥èƒä¸šåŠ¡</div>
            </div>
            <div class="record-detail">
                æ”¶å…¥: Â¥${repairRevenue.toFixed(2)}<br>
                è¡¥èƒæ•°é‡: ${repairs.reduce((sum, r) => sum + r.quantity, 0)} æ¡
            </div>
        </div>
        <div class="record-item">
            <div class="record-header">
                <div class="record-title">å…¶ä»–ä¸šåŠ¡</div>
            </div>
            <div class="record-detail">
                æ”¶å…¥: Â¥${otherRevenue.toFixed(2)}<br>
                ä¸šåŠ¡æ•°é‡: ${others.length} å•
            </div>
        </div>
    `;
}

function loadEmployeeManageList() {
    const employees = JSON.parse(localStorage.getItem('employees')).filter(e => e.approved);
    const changes = JSON.parse(localStorage.getItem('tireChanges'));
    const repairs = JSON.parse(localStorage.getItem('tireRepairs'));
    const others = JSON.parse(localStorage.getItem('otherBusiness'));

    const container = document.getElementById('employeeManageList');

    if (employees.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div>æš‚æ— å‘˜å·¥</div></div>';
    } else {
        container.innerHTML = employees.map(emp => {
            const empChanges = changes.filter(r => r.employee === emp.name);
            const empRepairs = repairs.filter(r => r.employee === emp.name);
            const empOthers = others.filter(r => r.employee === emp.name);

            const totalRevenue = empChanges.reduce((sum, r) => sum + r.price, 0) +
                                empRepairs.reduce((sum, r) => sum + r.price, 0) +
                                empOthers.reduce((sum, r) => sum + r.amount, 0);
            const totalOrders = empChanges.length + empRepairs.length + empOthers.length;

            return `
                <div class="record-item">
                    <div class="record-header">
                        <div class="record-title">${emp.name}</div>
                        <span class="approved-badge" style="background: #34d399;">å·²å®¡æ ¸</span>
                    </div>
                    <div class="record-detail">
                        æ³¨å†Œäº: ${formatDate(emp.registeredAt)}<br>
                        æ€»é”€å”®é¢: Â¥${totalRevenue.toFixed(2)}<br>
                        æ€»å•é‡: ${totalOrders} å•
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 12px;" onclick="resetEmployeePassword('${emp.name}')">é‡ç½®å¯†ç </button>
                    <button class="btn btn-danger" style="margin-top: 8px;" onclick="deleteEmployee('${emp.name}')">åˆ é™¤å‘˜å·¥</button>
                </div>
            `;
        }).join('');
    }
}

function resetEmployeePassword(name) {
    if (!confirm(`ç¡®å®šé‡ç½® ${name} çš„å¯†ç å—ï¼Ÿå¯†ç å°†é‡ç½®ä¸ºï¼š123456`)) return;

    const employees = JSON.parse(localStorage.getItem('employees'));
    const emp = employees.find(e => e.name === name);
    if (emp) {
        emp.password = '123456';
        localStorage.setItem('employees', JSON.stringify(employees));
        saveToCloud('employees', employees);
        alert(`å·²é‡ç½® ${name} çš„å¯†ç ä¸ºï¼š123456`);
    }
}

function deleteEmployee(name) {
    if (!confirm(`ç¡®å®šåˆ é™¤å‘˜å·¥ ${name} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

    const employees = JSON.parse(localStorage.getItem('employees'));
    const updatedEmployees = employees.filter(e => e.name !== name);
    localStorage.setItem('employees', JSON.stringify(updatedEmployees));
    saveToCloud('employees', updatedEmployees);
    alert(`å·²åˆ é™¤å‘˜å·¥ ${name}`);
    loadEmployeeManageList();
}

function changeBossPassword() {
    const current = document.getElementById('currentPassword').value;
    const newPwd = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmNewPassword').value;

    if (!current || !newPwd || !confirm) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
        return;
    }

    if (current !== localStorage.getItem('bossPassword')) {
        alert('å½“å‰å¯†ç é”™è¯¯ï¼');
        return;
    }

    if (newPwd !== confirm) {
        alert('ä¸¤æ¬¡æ–°å¯†ç ä¸ä¸€è‡´ï¼');
        return;
    }

    localStorage.setItem('bossPassword', newPwd);
    saveToCloud('bossPassword', newPwd);
    localStorage.removeItem('autoLogin');

    alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·é‡æ–°ç™»å½•');
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';

    logout();
}

function clearAllData() {
    if (!confirm('æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ä¸”ä¸å¯æ¢å¤ï¼ç¡®å®šç»§ç»­å—ï¼Ÿ')) return;
    if (!confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) return;

    localStorage.clear();
    alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
    location.reload();
}

// ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================
window.initMainApp = async function() {
    initData();

    // ä»äº‘ç«¯åŠ è½½æ•°æ®
    if (window.firestoreDB) {
        showSyncIndicator('syncing');

        const keys = ['employees', 'tireChanges', 'tireRepairs', 'otherBusiness', 'stockRecords', 'inventory', 'bossPassword', 'bossPIN'];

        for (const key of keys) {
            const cloudData = await loadFromCloud(key);
            if (cloudData !== null) {
                const dataString = typeof cloudData === 'string' ? cloudData : JSON.stringify(cloudData);
                localStorage.setItem(key, dataString);
            }
        }

        showSyncIndicator('success');

        // è®¾ç½®å®æ—¶åŒæ­¥
        setupRealtimeSync();
    }

    const autoLogin = localStorage.getItem('autoLogin');
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));

    if (autoLogin === 'true' && currentUser) {
        if (currentUser.role === 'employee') {
            const employees = JSON.parse(localStorage.getItem('employees'));
            const emp = employees.find(e => e.name === currentUser.name && e.approved);
            if (emp) {
                goToPage('employeeMainPage');
            } else {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('autoLogin');
                goToPage('welcomePage');
            }
        } else if (currentUser.role === 'boss') {
            goToPage('bossMainPage');
        }
    } else {
        goToPage('welcomePage');
    }
};

// ç­‰å¾…Firestoreåˆå§‹åŒ–åå†æ‰§è¡Œä¸»åº”ç”¨åˆå§‹åŒ–
setTimeout(() => {
    window.initMainApp();
}, 500);
    </script>
</body>
</html>
